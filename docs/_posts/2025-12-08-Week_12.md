---
title: "Mejora de nodo de grafo de visibilidad"
date: 2025-12-08
tags: [Progreso Semanal]
author: Carlos
---

## Mejora de grafo de visibilidad FMS

Esta semana he estado mejorando el nodo de grafo de visibilidad. Ahora posee 5 estados la la FMS:

1. BUILD GRAPH. Se carga el mapa, se detectan los polígonos y se genera o carga el grafo de visibilidad dependiendo si está generado o no. Una vez termina, pasa al estado WAIT GOAL.

2. WAIT GOAL. El robot está parado esperando un objetivo. Entra en este estado cuando:
    - Termina BUILD GRAPH
    - No encuentra una ruta al objetivo
    - La ruta está vacía
    - Se han completado todos los waypoints

3. EXTEND GRAPH. Una vez tenemos un goal, se extiende el grafo de visibilidad añadiendo los nodos de start y goal.

4. PLAN ROUTE. Cuando se comprueba que existe un camino, se entra en este estado. Se calcula la ruta óptima.

5. PILOTING. Entra en este estado cuando existe una ruta válida. El robot va siguiendo los waypoints hasta el destino


## Mejora de navegación del robot

Otro punto que estuve mejorando esta semana fue la navegación del robot. Inicialmente el robot giraba sobre sí mismo para orientarse al objetivo y una vez orientado navegaba hasta él siguiendo un control proporcional. Ahora, hemos conseguido un pilotaje mucho más suave y natural. Usamos dos controladores proporcionales P para:

1. Error angular. El robot gira más cuanto mayor es el error angular hacia el objetivo, y gira menos conforme se alinea.

2. Error de distancia. Usando la distancia euclídea al objetivo, cuanto más lejos está, más acelera.

En ambos casos las velocidades angular y lineal están limitadas. La lógica usada para la navegación es que si el robot está muy girado respecto al objetivo, no avanza rápido. La velocidad se multiplica por un factor que se acomoda a esa lógica. Así:

- Error angular ≈ 0°. Avanza a máxima velocidad.
- Error angular ≈ 45°. Avanza a la mitad de velocidad mientras corrige.
- Error angular >= 90°. Solo giro.



[![Ver video](https://img.youtube.com/vi/h83oTm-CwQQ/0.jpg)](https://www.youtube.com/watch?v=h83oTm-CwQQ)

















## Algoritmo RRT

Estas semanas he avanzado en la implementación de un nodo planificador de ruta basado en **RRT (Rapidly–Exploring Random Tree)**. Este algoritmo construye un árbol de búsqueda a partir de la posición inicial del robot. La idea principal de cómo funciona el nodo es:

- Genera un punto aleatorio en el espacio de búsqueda.

- Encuentra el nodo del árbol más cercano al punto.

- Expande el árbol desde ese nodo hacia la muestra, avanzando una distancia limitada (step size) si la muestra está más     lejos que el step size.

- Si el nuevo segmento no colisiona con ningún obstáculo, se añade el nuevo nodo al árbol.

- Si el nodo está lo suficientemente cerca de la meta, se intenta conectar con ésta para finalizar.


Véase que este algoritmo no optimiza la ruta, sino que encuentra un camino válido. En los siguientes vídeos podemos observar el algoritmo en acción. Se observa que para dos goals iguales, se obtienen rutas distintas a causa de la aleatoriedad en la que se basa RRT. 



[![Ver video](https://img.youtube.com/vi/6Laeb44z8o8/0.jpg)](https://www.youtube.com/watch?v=6Laeb44z8o8)



[![Ver video](https://img.youtube.com/vi/XnQt97nlhNM/0.jpg)](https://www.youtube.com/watch?v=XnQt97nlhNM)


Posibles mejoras que veo es que los parámetros sean configurables por comando en la terminal.

## Unificación en un nodo del ejercicio de grafo de visibilidad

Durante estas semanas estuve trabajando también en conseguir unificar en un nodo el planificador de ruta basada en grafo de visibilidad y el nodo que la sigue. 

1. Carga el mapa de polígonos y se genera el grafo de visibilidad si no existe. 
2. Espera odometría. Hasta que no se recibe /odom el nodo no puede generar una ruta.
3. Recibe un goal. Este será el objetivo al que deberá moverse el robot. 
4. Planificación de ruta con el start y goal.
5. Seguimiento de la ruta.

Ahora funciona como una máquina de estados finita (FMS). Así, los estados que tiene son:

- **IDLE**. El robot está quieto. Espera a que haya un goal y odometría válida. 

- **ROTATING**. El robot se orienta hacia el siguiente waypoint de la ruta. Una vez que el ángulo está dentro de la tolerancia fijada, el robot pasa a MOVING.

- **MOVING**. El robot avanza hacia el waypoint. Una vez alcanza el objetivo, si hay más waypoints en la ruta, pasa a ROTATING, y si no, a IDLE.


En el siguiente vídeo podemos ver el funcionamiento del nodo. Nótese que el goal propuesto es el mismo que en el algoritmo RRT. Obtenemos una ruta mucho más óptima. 

[![Ver video](https://img.youtube.com/vi/jw1PFC4XV4Q/0.jpg)](https://www.youtube.com/watch?v=jw1PFC4XV4Q)




